<!DOCTYPE html>
<meta charset="utf-8">
<head>
  <script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script> <!--D3 Library Import-->
  <script src="http://ajax.googleapis.com/ajax/libs/jquery/2.0.0/jquery.min.js"> </script> <!--JQuery Library Import-->
  <link rel="stylesheet" type="text/css" href="style.css"> <!--External CSS Import-->
  <link href='https://fonts.googleapis.com/css?family=Roboto:400,300,500,100' rel='stylesheet' type='text/css'> <!-- Import Roboto Font -->
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" integrity="sha384-1q8mTJOASx8j1Au+a5WDVnPi2lkFfwwEAa8hDDdjZlpLegxhjVME1fgjWPGmkzs7" crossorigin="anonymous"> <!-- Import Bootstrap -->
  <script src="http://d3js.org/topojson.v1.min.js"></script> <!-- Import map JSON -->
</head>

<body>
<div class="container">
    <div class="row title-row">
        <div class="col-xs-12" id="title">
            <h1 class="center">Master of MVPs</h1>
            <h6 class="center">By Chris Traver, Rohit Biswas & Chris Vrabel</h6>
            <p class="center">A data visualization of NBA, NHL, MLB, and NBA most valuable players (MVPs) between 2000-2015.</p>
        </div>
    </div>
    <div class="row interactive-map">
        <div class="col-xs-12" id="mvp-picker"></div>
        <div id="instructions">
          <h3>Instructions</h3>
          <p>Begin by selecting a point on the map below.  Different sports are represented by different icons, and the locations
          of each icon represent the hometown of that MVP.</p>
          <p>You can zoom and pan using your mouse and the scroll wheel.  You can also hover over a data point
          to view bio information about that MVP.</p>
          <p>Next, click on an icon to load it into the detailed visualization below the map.</p>
          <button id="instructions-close">Lets go!</button>
        </div>
    </div>
    <div class="row player-visualizations">
        <div class="col-xs-12" id="mvp-stats"></div>
    </div>
    <div class="row overall-stats-title">
        <div class="col-xs-12" >
                <h2 class="center">Overall Statistics</h2>
                <p class="center">There are many surprising commonalities between NHL, NBA, MLB, and NFL most valuable players.  Here
                is a breakdown of some interesting trends.</p>
        </div>
    </div>
    <div class="row overall-stats">
        <div class="col-xs-12 scatterplot-dropdowns">
          <h3 class="blue">Age & Salary Comparison</h3>
          <p>This graph explores the relationship between salary and a player's age at the time they were awarded MVP.
          <br>Hover over a datapoint to learn more about that MVP.</p><br>
          <span><strong>Filter By College: </strong></span><span class="college-dropdown"></span>
          <span><strong>Filter By Team: </strong></span><span class="team-dropdown"></span>
          <span><strong>Filter By Sport: </strong></span><span class="sport-dropdown"></span>
        </div>
        <div class="col-xs-12 scatterplot"></div>
        <div class="col-xs-12 scatterplot-dropdowns">
          <h3 class="blue">MVP Characteristic Distributions</h3>
          <p>This graph explores the relationships between a variety of different characteristics about MVPs
          at the time they were awarded MVP.
          <br>Use the toggles below to interact with the data.</p><br>
          <form id="groupStackForm">
            <button type="button" class="histogramButton" value="grouped">Grouped</button>
            <button type="button" class="histogramButton" value="stacked">Stacked</button>
          </form>
          <br><br>
          <form id="categoryForm">
            <button type="button" class="histogramButton" value="Height">Height</button>
            <button type="button" class="histogramButton" value="Weight">Weight</button>
            <button type="button" class="histogramButton" value="Age">Age</button>
            <button type="button" class="histogramButton" value="Salary">Salary</button>
          </form>
          
        </div>
        <div class="col-xs-12 histogram" id="overall-stats"></div>
    </div>
</div> 

</body>

<script>

var width = 1600,
    height = 500,
    scale0 = (width - 1) / 2 / Math.PI;

var projection = d3.geo.mercator();

var zoom = d3.behavior.zoom()
    .translate([width / 2, height / 2])
    .scale(scale0)
    .scaleExtent([scale0,   24 * scale0])
    .on("zoom", zoomed);

var path = d3.geo.path()
    .projection(projection);

var svg = d3.select("#mvp-picker").append("svg")
    .attr("width", width)
    .attr("height", height)
    .attr("class", "map")
  .append("g");

var g = svg.append("g");

var tip = d3.select(".interactive-map").append("div")
            .attr("class", "tooltip")
            .style("opacity", 0);
    
svg.append("rect")
    .attr("class", "overlay")
    .attr("width", width)
    .attr("height", height);

svg
    .call(zoom)
    .call(zoom.event);

d3.json("resources/world-110m.json", function(error, world) {
  if (error) throw error;

  g.append("path")
      .datum({type: "Sphere"})
      .attr("class", "sphere")
      .attr("d", path);

  g.append("path")
      .datum(topojson.merge(world, world.objects.countries.geometries))
      .attr("class", "land")
      .attr("d", path);

  g.append("path")
      .datum(topojson.mesh(world, world.objects.countries, function(a, b) { return a !== b; }))
      .attr("class", "boundary")
      .attr("d", path);

});


rightWidth = 500;
rightHeight = 500;
var rightWindow = d3.select("#mvp-stats").append("svg")
    .attr("width", rightWidth)
    .attr("height", rightHeight)
  .append("g");

rightWindow.append("text")
            .text("Hello")
            .attr("x", rightWidth/2)
            .attr("text-anchor", "middle")
            .attr("y", rightHeight*.1)
            .attr("font-size", "50px")
            .attr("id", "rightTitle");

function zoomed() {
  projection
      .translate(zoom.translate())
      .scale(zoom.scale());

  g.selectAll("path")
      .attr("d", path);

  svg.selectAll("image").attr("x", function(d) {return projection([d.Longitude, d.Latitude])[0]})
  .attr("y", function(d) {return projection([d.Longitude, d.Latitude])[1]})
}

d3.select(self.frameElement).style("height", height + "px");

var mvp_data;

d3.csv("data/mvp_list.csv", function (error, rows) {
  
  mvp_data = rows;
  
  function remove_duplicates(c, optArray) {
    var mvp_data = rows;
    if (optArray) {mvp_data = optArray}
    mvp_data_copy = [];
    var set = new Set();
    
    if (c=="College") {
      for(var k = 0; k < mvp_data.length; k++){
        if(set.has(mvp_data[k].College)){
          continue;
        }
        else{
          mvp_data_copy.push(mvp_data[k]);
          set.add(mvp_data[k].College);
        }
      }        
    }
    if (c=="Player") {
      for(var k = 0; k < mvp_data.length; k++){
        if(set.has(mvp_data[k].Player)){
          continue;
        }
        else{
          mvp_data_copy.push(mvp_data[k]);
          set.add(mvp_data[k].Player);
        }
      }        
    }
    if (c=="Team") {
      for(var k = 0; k < mvp_data.length; k++){
        if(set.has(mvp_data[k].Team)){
          continue;
        }
        else{
          mvp_data_copy.push(mvp_data[k]);
          set.add(mvp_data[k].Team);
        }
      }        
    }
    if (c=="Hometown") {
      for(var k = 0; k < mvp_data.length; k++){
        if(set.has(mvp_data[k].Hometown)){
          continue;
        }
        else{
          mvp_data_copy.push(mvp_data[k]);
          set.add(mvp_data[k].Hometown);
        }
      }        
    }
    if (c=="League") {
      for(var k = 0; k < mvp_data.length; k++){
        if(set.has(mvp_data[k].League)){
          continue;
        }
        else{
          mvp_data_copy.push(mvp_data[k]);
          set.add(mvp_data[k].League);
        }
      }        
    }
    return mvp_data_copy;
  }

  var playerPointsNoDup = svg.selectAll(".playerPoints").data(remove_duplicates("Player"), function(d) {return d.ID;});
  
  playerPointsNoDup
    .enter().append("image")
    .attr("x", function(d) {return projection([d.Longitude, d.Latitude])[0];})
    .attr("y", function(d) {return projection([d.Longitude, d.Latitude])[1];})
    .attr("name", function(d) {return d.Player;})
    .attr("hometown", function(d) {return d.Hometown;})
    .attr("age", function(d) {return d.Age;})
    .attr("pheight", function(d) {return d.Height;})
    .attr("weight", function(d) {return d.Weight;})
    .attr("team", function(d) {return d.Team;})
    .attr("college", function(d) {return d.College;})
    .attr("salary", function(d) {return d.Salary;})
    .attr("position", function(d) {return d.Position;})
    .attr("width", 20)
    .attr("height", 20)
    .style("opacity", "0.4")
    .attr("xlink:href", function (d) {
          if (d.League == "MLB") {
              return "resources/images/mlb.png";
          }                  
          if (d.League == "NHL") {
              return "resources/images/nhl.png";
          }
          if (d.League == "NBA") {
              return "resources/images/nba.png";
          }
          if (d.League == "NFL") {
              return "resources/images/nfl.png";
          }
    });

  playerPointsNoDup.on('mouseover',function(){
        var curr = d3.select(this);
        curr.style("opacity", "0.7");
        var name = curr.attr("name");
        var age = curr.attr("age");
        var hometown = curr.attr("hometown");
        var salary = curr.attr("salary");
        var weight = curr.attr("weight");
        var playerHeight = curr.attr("pheight");
        var team = curr.attr("team");
        var college = curr.attr("college");
        var position = curr.attr("position");
        //svg.append("text")
        //  .text(name + ' - ' + hometown)
        //  .attr("x", width/2)
        //  .attr("text-anchor", "middle")
        //  .attr("y", height*.95)
        //  .style("font-size", "20px")
        //  .attr("stroke","black")
        //  .attr("id","playerLabel");

        name.split(' ').join('_')
        tip.transition()    
                .duration(200)    
                .style("opacity", .9);    
        tip.html("<img src='resources/images/player-photos/" + name.toLowerCase().split(' ').join('_') + ".jpg'" +
                  "style='float: left;',  height=160, width=130> <h4>"
                  + name + "</h4>" + "<br/>"  +
                  "<strong><u>Hometown:</u></strong>  " + hometown + "<br/>" + 
                  "<strong><u>Team:</u></strong>  " + team + "<br/>" + 
                  "<strong><u>Position:</u></strong>  " + position + "<br/>" + 
                  "<strong><u>Age:</u></strong>  " + age + "<br/>" + 
                  "<strong><u>Height:</u></strong>  " + playerHeight + "<br/>" + 
                  "<strong><u>Weight:</u></strong>  " + weight + " lbs<br/>" +
                  "<strong><u>College:</u></strong>  " + college + "<br/>" + 
                  "<strong><u>Salary:</u></strong>  $" + salary + "<br/>")
            .style("left", (d3.event.pageX) + "px")   
            .style("top", (d3.event.pageY - 28) + "px");  
  });
            
  playerPointsNoDup.on('mouseout',function(){
				d3.select(this).style("opacity", "0.4");
        svg.select("#playerLabel").remove();
        tip.transition()    
                .duration(500)    
                .style("opacity", 0); 
	});

  playerPointsNoDup.on('click',function(){
        var curr = d3.select(this);
        var name = curr.attr("name");
        rightWindow.select("#rightTitle")
                    .text(name);

  });
  
  d3.select("#instructions-close").on("click", function() {
      d3.select("#instructions").remove();
  });
  
  var margin = {top: 20, right: 100, bottom: 100, left: 150},
  width = 1260 - margin.left - margin.right,
  height = 500 - margin.top - margin.bottom;

  var x = d3.scale.linear()
    .range([0, width]);

  var y = d3.scale.linear()
    .range([height, 0]);

  var color = d3.scale.category10();

  var xAxis = d3.svg.axis()
    .scale(x)
    .orient("bottom");

  var yAxis = d3.svg.axis()
    .scale(y)
    .orient("left");

  var scatterplot = d3.select(".scatterplot").append("svg")
    .attr("width", width + margin.left + margin.right)
    .attr("height", height + margin.top + margin.bottom)
  .append("g")
    .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

  // Define the div for the tooltip
  var div = d3.select(".scatterplot").append("div")	
    .attr("class", "scatterplot-tooltip")				
    .style("opacity", 0);
    
  x.domain(d3.extent(rows, function(d) { return Number(d.Age); })).nice();
  y.domain(d3.extent(rows, function(d) { return Number(d.Salary); })).nice();

  scatterplot.append("g")
      .attr("class", "x axis")
      .attr("transform", "translate(0," + height + ")")
      .call(xAxis)
    .append("text")
      .attr("class", "label")
      .attr("x", width)
      .attr("y", -6)
      .style("text-anchor", "end")
      .text("Age (yrs)");

  scatterplot.append("g")
      .attr("class", "y axis")
      .call(yAxis)
    .append("text")
      .attr("class", "label")
      .attr("transform", "rotate(-90)")
      .attr("y", 6)
      .attr("dy", ".71em")
      .style("text-anchor", "end")
      .text("Salary ($)")

  format = d3.format("0,000");

  var dots = scatterplot.selectAll(".dot").data(mvp_data, function(d) {return d.ID;});
  dots.enter().append("circle")
      .attr("class", function(d) { return "dot " + d.Team + " " + d.College.split(' ').join('_')})
      .attr("r", 3.5)
      .attr("cx", function(d) { return x(Number(d.Age)); })
      .attr("cy", function(d) { return y(Number(d.Salary)); })
      .style("fill", function(d) { return color(d.League); })
      .on("mouseover", function(d) {		
            d.Player.split(' ').join('_')
            tip.transition()    
                    .duration(200)    
                    .style("opacity", .9);    
            tip.html("<img src='resources/images/player-photos/" + d.Player.toLowerCase().split(' ').join('_') + ".jpg'" +
                      "style='float: left;',  height=160, width=130> <h4>"
                      + d.Player + "</h4>" + "<br/>"  +
                      "<strong><u>Hometown:</u></strong>  " + d.Hometown + "<br/>" + 
                      "<strong><u>Team:</u></strong>  " + d.Team + "<br/>" + 
                      "<strong><u>Position:</u></strong>  " + d.Position + "<br/>" + 
                      "<strong><u>Age:</u></strong>  " + d.Age + "<br/>" + 
                      "<strong><u>Height:</u></strong>  " + d.Height + "<br/>" + 
                      "<strong><u>Weight:</u></strong>  " + d.Weight + " lbs<br/>" +
                      "<strong><u>College:</u></strong>  " + d.College + "<br/>" + 
                      "<strong><u>Salary:</u></strong>  $" + d.Salary + "<br/>")
                .style("left", (d3.event.pageX) + "px")   
                .style("top", (d3.event.pageY - 28) + "px");
      })
        .on("mouseout", function(d) {		
            tip.transition()		
                .duration(500)		
                .style("opacity", 0);	
      });


  var legend = scatterplot.selectAll(".legend")
      .data(color.domain())
    .enter().append("g")
      .attr("class", "legend")
      .attr("transform", function(d, i) { return "translate(0," + i * 20 + ")"; });

  legend.append("rect")
      .attr("x", width - 18)
      .attr("width", 18)
      .attr("height", 18)
      .style("fill", color);

  legend.append("text")
      .attr("x", width - 24)
      .attr("y", 9)
      .attr("dy", ".35em")
      .style("text-anchor", "end")
      .text(function(d) { return d; });
   
  var collegeDropDown = d3.select(".college-dropdown").append("select")
                    .attr("name", "college-list");
  var teamDropDown = d3.select(".team-dropdown").append("select")
                    .attr("name", "team-list");
  var leagueDropDown = d3.select(".sport-dropdown").append("select")
                    .attr("name", "sport-list"); 
  


  var colleges = remove_duplicates("College");
  var teams = remove_duplicates("Team");
  var leagues = remove_duplicates("League");
  var allobject = {Age:"-- All --",
    College:"-- All --",
    Height:"-- All --",
    Hometown:"-- All --",
    Latitude:"-- All --",
    League:"-- All --",
    Longitude:"-- All --",
    Player:"-- All --",
    Position:"-- All --",
    Salary:"-- All --",
    Season:"-- All --",
    Subleague:"-- All --",
    Team:"-- All --",
    Weight:"-- All --"
  };
  colleges.unshift(allobject);
  teams.unshift(allobject);
  leagues.unshift(allobject);
  var collegeOptions = collegeDropDown.selectAll("option")
           .data(colleges)
         .enter()
           .append("option");
  var teamOptions = teamDropDown.selectAll("option")
           .data(teams)
         .enter()
           .append("option");
  var leagueOptions = leagueDropDown.selectAll("option")
           .data(leagues)
         .enter()
           .append("option");
           
  collegeOptions.text(function (d) { return d.College; })
      .attr("value", function (d) { return d.College; })
      .attr("id", function (d) { return d.College.split(' ').join('_'); });
  teamOptions.text(function (d) { return d.Team; })
      .attr("value", function (d) { return d.Team; })
      .attr("id", function (d) { return d.Team.split(' ').join('_'); });
  leagueOptions.text(function (d) { return d.League; })
      .attr("value", function (d) { return d.League; })
      .attr("id", function (d) { return d.League.split(' ').join('_'); });

  collegeDropDown.on("change", filterHandlerCollege);
  teamDropDown.on("change", filterHandlerTeam);
  leagueDropDown.on("change", filterHandlerLeague);

  function filterHandlerCollege() {
    filterDots("College");
  }
  function filterHandlerTeam() {
    filterDots("Team");
  }
  function filterHandlerLeague() {
    filterDots("League");
  }

  function filterDots(typeChanged) {
    var college = collegeDropDown.node().value;
    var team = teamDropDown.node().value;
    var league = leagueDropDown.node().value;

    var newData = mvp_data.filter( function(d) {
      return (d.College == college || college == "-- All --") &&
             (d.Team == team || team == "-- All --") &&
             (d.League == league || league == "-- All --"); 
    });
    dots = scatterplot.selectAll(".dot").data(newData, function(d) {return d.ID;});
    dots.enter();
    dots.attr("display","inline");
    dots.exit().attr("display","none");

    var newColleges = remove_duplicates("College",newData);
    var newTeams = remove_duplicates("Team",newData);
    var newLeagues = remove_duplicates("League",newData);

    newColleges.unshift(allobject);
    newTeams.unshift(allobject);
    newLeagues.unshift(allobject);

    collegeOptions = collegeDropDown.selectAll("option").data(newColleges);
    collegeOptions.enter().append("option");
    teamOptions = teamDropDown.selectAll("option").data(newTeams);
    teamOptions.enter().append("option");
    leagueOptions = leagueDropDown.selectAll("option").data(newLeagues);
    leagueOptions.enter().append("option");

    collegeOptions.text(function (d) { return d.College; })
        .attr("value", function (d) { return d.College; })
        .attr("id", function (d) { return d.College.split(' ').join('_'); });
    teamOptions.text(function (d) { return d.Team; })
        .attr("value", function (d) { return d.Team; })
        .attr("id", function (d) { return d.Team.split(' ').join('_'); });
    leagueOptions.text(function (d) { return d.League; })
        .attr("value", function (d) { return d.League; })
        .attr("id", function (d) { return d.League.split(' ').join('_'); });

    collegeOptions.exit().remove();
    teamOptions.exit().remove();
    leagueOptions.exit().remove();

    switch (typeChanged) {
      case "College":
        d3.select('#'+college.split(' ').join('_')).property("selected", "selected");
        break;
      case "Team":
        d3.select('#'+team.split(' ').join('_')).property("selected", "selected");
        break;
      case "League":
        d3.select('#'+league.split(' ').join('_')).property("selected", "selected");
        break;
      default:
        console.log(typeChanged);
    }
    

  }
});

</script>




<script>

var width = 750,
    height = 500;

var mvp_data;
var probe;
d3.csv("data/mvp_list.csv", function (error, rows) {
  
  mvp_data = rows;

  var color = d3.scale.category10();
  //ensures consistent order of coloring
  var leagues = ["NBA", "NFL", "NHL", "MLB"];

  var margin = {top: 40, right: 50, bottom: 50, left: 50},
      width = 1260 - margin.left - margin.right,
      height = 500 - margin.top - margin.bottom,
      barSpacing = .5;

  var categoryToUnits = {Age: "(yr)", Height: "(in)", Weight: "(lb)", Salary: "($100,000)", }

  var MLBRows = mvp_data.filter(function (row) {return row["League"] == 'MLB';}),
    NFLRows = mvp_data.filter(function (row) {return row["League"] == 'NFL';}),
    NBARows = mvp_data.filter(function (row) {return row["League"] == 'NBA';}),
    NHLRows = mvp_data.filter(function (row) {return row["League"] == 'NHL';});

  var histogram = d3.select("#overall-stats").append("svg")
      .attr("id","histogram")
      .attr("width", width + margin.left + margin.right)
      .attr("height", height + margin.top + margin.bottom)
    .append("g")
      .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

  var yScale, xScale, labelScale, rect, layer, yAxis, xAxis, layers, yGroupMax, yStackMax, numBins, category;

  var currentMode = "stacked";
  var category = "Age";
  initCategory();

  d3.selectAll(".histogramButton").on("click",function() {
    switch (this.value) {
      case "grouped": 
        currentMode = this.value;
        transitionGrouped(); 
        break;
      case "stacked": 
        currentMode = this.value;
        transitionStacked(); 
        break;
      default:
        category = this.value;
        transitionCategory();
    }
  });

  function transitionGrouped() {
    yScale.domain([0, yGroupMax]);
    d3.selectAll(".yAxis").remove();
    histogram.append("g")
      .attr("class", "yAxis")
      .attr("transform", "translate(" + margin.left + ",0)")
      .call(yAxis)
      .append("text")
        .attr("class", "label")
        .attr("transform", "rotate(-90)")
        .attr("y", 6)
        .attr("dy", ".71em")
        .style("text-anchor", "end")
        .text("Frequency");

    rect = layer.selectAll("rect");
    rect.transition()
        .duration(500)
        .delay(function(d, i) { return i * 10; })
        .attr("x", function(d, i, j) { return xScale(d.x) + xScale.rangeBand() / 4 * j; })
        .attr("width", xScale.rangeBand() / 4)
      .transition()
        .attr("y", function(d) { return yScale(d.y); })
        .attr("height", function(d) { return height - yScale(d.y); });
  }

  function transitionStacked() {
    yScale.domain([0, yStackMax]);
    d3.selectAll(".yAxis").remove();
    histogram.append("g")
      .attr("class", "yAxis")
      .attr("transform", "translate(" + margin.left + ",0)")
      .call(yAxis)
        .append("text")
        .attr("class", "label")
        .attr("transform", "rotate(-90)")
        .attr("y", 6)
        .attr("dy", ".71em")
        .style("text-anchor", "end")
        .text("Frequency");;

    rect = layer.selectAll("rect");
    rect.transition()
        .duration(500)
        .delay(function(d, i) { return i * 10; })
        .attr("y", function(d) { return yScale(d.y0 + d.y); })
        .attr("height", function(d) { return yScale(d.y0) - yScale(d.y0 + d.y); })
      .transition()
        .attr("x", function(d) { return xScale(d.x); })
        .attr("width", xScale.rangeBand());
  }

  function getData() {
    var categoryToBins= {Age: 10, Height: 10, Weight: 10, Salary: 10};
    var dataMod = (category==="Salary")?1/100000:1;
    var endSubtractor = {Age: 1, Height: .1, Weight: 1, Salary: 100000};
    numBins = categoryToBins[category];

    var maxMin = d3.extent(mvp_data, function (row) {return Number(row[category]);}),
      range = maxMin[1]-maxMin[0];

    var MLBBins=[],
      NFLBins=[],
      NBABins=[],
      NHLBins=[];
    for (var i = numBins; i >= 0; i--) {
      var begin = i*(range/numBins)+maxMin[0],
        end = (i+1)*(range/numBins)+maxMin[0]-endSubtractor[category];
      var begin = Math.floor(10*begin*dataMod)/10,
        end = Math.floor(10*end*dataMod)/10;
      var label = String(begin) + "-" + String(end);
      //Initialize all bins with this format
      MLBBins[i]={x: end, label: label, y: 0, id: i};
        NFLBins[i]={x: end, label: label, y: 0, id: numBins + i};
        NBABins[i]={x: end, label: label, y: 0, id: numBins*2 + i};
        NHLBins[i]={x: end, label: label, y: 0, id: numBins*3 + i};
    }

    MLBRows.forEach(function (row) {
      var ind = Math.floor((row[category]-maxMin[0])/(range/numBins));
      MLBBins[ind].y++;});
    NFLRows.forEach(function (row) {
      var ind = Math.floor((row[category]-maxMin[0])/(range/numBins));
      NFLBins[ind].y++;});
    NBARows.forEach(function (row) {
      var ind = Math.floor((row[category]-maxMin[0])/(range/numBins));
      NBABins[ind].y++;});
    NHLRows.forEach(function (row) {
      var ind = Math.floor((row[category]-maxMin[0])/(range/numBins));
      NHLBins[ind].y++;});

    var allBins = [NBABins, NFLBins, NHLBins, MLBBins];

    //Adapted from mbostock, at http://bl.ocks.org/mbostock/3943967
    var stack = d3.layout.stack();
    layers = stack(d3.range(4).map(function(d, i) { return allBins[i]; })),
    // layers.forEach(function(layer,i) {layer.id = leagues[i];})
    yGroupMax = d3.max(layers, function(layer) { return d3.max(layer, function(d) { return d.y; }); }),
    yStackMax = d3.max(layers, function(layer) { return d3.max(layer, function(d) { return d.y0 + d.y; }); });

    xScale = d3.scale.ordinal()
        .domain(MLBBins.map(function(d){return d.x;}))
        .rangeRoundBands([margin.left, width], barSpacing);

    yScale = d3.scale.linear()
        .domain([0, yStackMax])
        .range([height, 0]);

    labelScale = d3.scale.ordinal()
        .domain(MLBBins.map(function(d){return d.label;}))
        .rangeRoundBands([margin.left, width], barSpacing);

    xAxis = d3.svg.axis()
        .scale(labelScale)
        .tickSize(0)
        .tickPadding(6)
        .orient("bottom");
    yAxis = d3.svg.axis()
      .scale(yScale)
      .tickSize(1)
      .tickPadding(6)
      .orient("left");
  }

  function initCategory() {
    getData();

    layer = histogram.selectAll(".layer")
        .data(layers)
      .enter().append("g")
        .attr("class", "layer")
        .style("fill", function(d, i) { return color(leagues[i]); });

    rect = layer.selectAll("rect")
        .data(function(d) { return d; })
      .enter().append("rect")
        .attr("x", function(d) { return xScale(d.x); })
        .attr("y", height)
        .attr("width", xScale.rangeBand())
        .attr("height", 0);

    rect.transition().duration(1500)
        .attr("y", function(d) { return yScale(d.y0 + d.y); })
        .attr("height", function(d) { return yScale(d.y0) - yScale(d.y0 + d.y); });

    histogram.append("g").attr("class", "xAxis")
        .attr("transform", "translate(0," + height + ")")
        .call(xAxis)
        .append("text")
          .attr("class", "label")
          .attr("x", width/2)
          .attr("y", 28)
          .attr("dy", ".71em")
          .style("text-anchor", "center")
          .style("font-size", "12pt")
          .text(category + " " + categoryToUnits[category]);
    histogram.append("g").attr("class", "yAxis")
        .attr("transform", "translate(" + margin.left + ",0)")
        .call(yAxis)
        .append("text")
          .attr("class", "label")
          .attr("transform", "rotate(-90)")
          .attr("y", 6)
          .attr("dy", ".71em")
          .style("text-anchor", "end")
          .text("Frequency");
          
    var legend = d3.select("#histogram").selectAll(".legend")
      .data(color.domain())
    .enter().append("g")
      .attr("class", "legend")
      .attr("transform", function(d, i) { return "translate(0," + i * 20 + ")"; });

    legend.append("rect")
        .attr("x", width - 18)
        .attr("width", 18)
        .attr("height", 18)
        .style("fill", color);

    legend.append("text")
        .attr("x", width - 24)
        .attr("y", 9)
        .attr("dy", ".35em")
        .style("text-anchor", "end")
        .text(function(d) { return d; });
  }

  function transitionCategory() {
    getData();

    layer = histogram.selectAll(".layer")
        .data(layers)
        .style("fill", function(d, i) { return color(leagues[i]); });
    layer.exit().remove();

    rect = layer.selectAll("rect")
        .data(function(d) { return d; })
        .transition().duration(500)
        .attr("x", function(d) { return xScale(d.x); })
        .attr("y", height-20)
        .attr("width", xScale.rangeBand()/4)
        .attr("height",20);

    if (currentMode==="grouped") {
      yScale.domain([0, yGroupMax]);
      d3.selectAll(".yAxis").remove();
      histogram.append("g")
        .attr("class", "yAxis")
        .attr("transform", "translate(" + margin.left + ",0)")
        .call(yAxis)
        .append("text")
          .attr("class", "label")
          .attr("transform", "rotate(-90)")
          .attr("y", 6)
          .attr("dy", ".71em")
          .style("text-anchor", "end")
          .text("Frequency");;
      rect.transition()
        .duration(500)
        .attr("x", function(d, i, j) { return xScale(d.x) + xScale.rangeBand() / 4 * j; })
        .attr("width", xScale.rangeBand() / 4)
        .attr("y", function(d) { return yScale(d.y); })
        .attr("height", function(d) { return height - yScale(d.y); });
    } else {
      yScale.domain([0, yStackMax]);
      d3.selectAll(".yAxis").remove();
      histogram.append("g")
        .attr("class", "yAxis")
        .attr("transform", "translate(" + margin.left + ",0)")
        .call(yAxis)
        .append("text")
          .attr("class", "label")
          .attr("transform", "rotate(-90)")
          .attr("y", 6)
          .attr("dy", ".71em")
          .style("text-anchor", "end")
          .text("Frequency");;

      rect.transition().duration(500)
        .attr("x", function(d) { return xScale(d.x); })
        .attr("width", xScale.rangeBand())
        .attr("y", function(d) { return yScale(d.y0 + d.y); })
        .attr("height", function(d) { return yScale(d.y0) - yScale(d.y0 + d.y); });
    }

    //Reset Axes
    d3.selectAll(".xAxis").remove();
    d3.selectAll(".yAxis").remove();
    histogram.append("g").attr("class", "xAxis")
        .attr("transform", "translate(0," + height + ")")
        .call(xAxis)
        .append("text")
          .attr("class", "label")
          .attr("x", width/2)
          .attr("y", 28)
          .attr("dy", ".71em")
          .style("text-anchor", "center")
          .style("font-size", "12pt")
          .text(category + " " + categoryToUnits[category]);
    histogram.append("g").attr("class", "yAxis")
        .attr("transform", "translate(" + margin.left + ",0)")
        .call(yAxis)
        .append("text")
          .attr("class", "label")
          .attr("transform", "rotate(-90)")
          .attr("y", 6)
          .attr("dy", ".71em")
          .style("text-anchor", "end")
          .text("Frequency");
  }
});
</script>




</html>
